<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tchoff â€” Hash-based Gallery</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/theme-loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <div class="nav-dropdown-wrap">
        <button type="button" class="btn-icon nav-menu-btn" id="nav-menu-btn" aria-label="Menu" aria-haspopup="true" aria-expanded="false" title="Navigate">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="nav-dropdown" id="nav-dropdown" role="menu">
          <a href="/" role="menuitem" aria-current="page">Feed</a>
          <a href="/babel.html" role="menuitem">Babel Library</a>
          <a href="/sound.html" role="menuitem">Wall of Sound</a>
          <a href="/soundboard.html" role="menuitem">Soundboard</a>
          <a href="/dj.html" role="menuitem">DJ Table</a>
          <a href="/movie-maker.html" role="menuitem">Movie Maker</a>
          <a href="/hashes.html" role="menuitem">Image Hashes</a>
          <a href="/sound-hashes.html" role="menuitem">Sound Hashes</a>
          <a href="/themes.html" role="menuitem">Themes</a>
          <a href="/#upload" role="menuitem">Upload Image</a>
          <a href="/#upload-audio" role="menuitem">Upload Audio</a>
          <a href="/#hash" role="menuitem">View by Hash</a>
          <a href="/#auth" role="menuitem">Sign in / Account</a>
          <a href="/terms.html" role="menuitem">Terms of Use</a>
          <a href="/privacy.html" role="menuitem">Privacy Policy</a>
        </div>
      </div>
      <button class="btn-icon" id="btn-upload" title="Upload">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </button>
      <button class="btn-icon" id="btn-auth" title="Sign in / Account">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </nav>
  </header>

  <main class="main">
    <section class="feed" id="feed">
      <div class="feed-grid grid-4x4" id="feed-grid"></div>
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon" aria-hidden="true">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <path d="M21 15l-5-5L5 21"/>
          </svg>
        </div>
        <p>No images yet. Drop an image or click Upload â€” HEIC from iPhone/iPad supported.</p>
      </div>
      <nav class="pagination" id="pagination"></nav>
    </section>
  </main>

  <footer class="site-footer">
    <a href="/terms.html">Terms of Use</a>
    <span class="footer-sep">Â·</span>
    <a href="/privacy.html">Privacy Policy</a>
  </footer>

  <!-- Auth modal -->
  <dialog class="modal" id="auth-modal">
    <div class="modal-content">
      <button type="button" class="btn-close" id="close-auth" aria-label="Close">Ã—</button>
      <h2 id="auth-title">Sign in</h2>
      <p class="modal-hint" id="auth-hint">Create an account with your email to upload images.</p>
      <div id="auth-logged-in" style="display:none">
        <p class="modal-hint">Signed in as <strong id="auth-username-display"></strong></p>
        <div id="auth-username-edit" style="display:none; margin-bottom:16px">
          <input type="text" id="auth-username-input" placeholder="Username (3â€“30 chars)" maxlength="30" pattern="[a-zA-Z0-9_]{3,30}" title="Letters, numbers, underscores only">
          <div class="modal-actions" style="margin-top:8px">
            <button type="button" class="btn btn-ghost" id="auth-username-cancel">Cancel</button>
            <button type="button" class="btn btn-primary" id="auth-username-save">Save</button>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="btn-edit-username">Change username</button>
          <button type="button" class="btn btn-ghost" id="btn-logout">Log out</button>
        </div>
        <div class="friends-section" id="friends-section">
          <label>Add friend</label>
          <div class="add-friend-row add-friend-search-wrap">
            <input type="text" id="add-friend-username" placeholder="Search by usernameâ€¦" autocomplete="off">
            <div id="friend-search-results" class="friend-search-results" style="display:none"></div>
            <button type="button" class="btn btn-primary" id="btn-add-friend">Add</button>
          </div>
          <div class="friends-list" id="friends-list"></div>
          <div class="pending-requests" id="pending-requests"></div>
        </div>
      </div>
      <div id="auth-forms">
      <div class="auth-tabs">
        <button type="button" class="auth-tab active" data-tab="login">Log in</button>
        <button type="button" class="auth-tab" data-tab="signup">Sign up</button>
      </div>
      <form id="auth-login-form" class="auth-form active">
        <input type="email" id="auth-email" placeholder="Email" required>
        <input type="password" id="auth-password" placeholder="Password" minlength="6" required>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="cancel-auth">Cancel</button>
          <button type="submit" class="btn btn-primary">Log in</button>
        </div>
      </form>
      <form id="auth-signup-form" class="auth-form">
        <div id="auth-signup-error" class="error" style="display:none; margin-bottom:12px"></div>
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="text" id="signup-username" placeholder="Username (3â€“30 chars, letters, numbers, _)" minlength="3" maxlength="30" pattern="[a-zA-Z0-9_]+" title="Letters, numbers, underscores only">
        <input type="password" id="signup-password" placeholder="Password (min 6 chars)" minlength="6" required>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="cancel-auth-signup">Cancel</button>
          <button type="submit" class="btn btn-primary">Create account</button>
        </div>
      </form>
      </div>
    </div>
  </dialog>

  <!-- Upload modal (Image + Audio) -->
  <dialog class="modal" id="upload-modal">
    <div class="modal-content modal-content-upload">
      <button type="button" class="btn-close" id="close-upload" aria-label="Close">Ã—</button>
      <h2>Upload Media</h2>
      <div class="upload-media-tabs">
        <button type="button" class="upload-media-tab active" data-type="image" title="Images, HEIC supported">ðŸ“· Image</button>
        <button type="button" class="upload-media-tab" data-type="audio" title="Audio up to 30 sec">ðŸŽµ Audio</button>
      </div>

      <div id="upload-image-panel" class="upload-type-panel">
        <p class="modal-hint">Take a photo or choose from library. HEIC from iPhone/iPad supported.</p>
        <div class="upload-source-tabs">
          <button type="button" class="upload-tab active" data-source="browse">Browse</button>
          <button type="button" class="upload-tab" data-source="camera">Take Photo</button>
        </div>
        <div class="upload-dropzone" id="dropzone">
          <input type="file" id="file-input" accept="image/*,image/heic,image/heif,.heic,.heif" hidden>
          <input type="file" id="camera-input" accept="image/*" capture="environment" hidden>
          <div id="camera-container" class="camera-container" style="display:none">
            <video id="camera-preview" autoplay playsinline muted></video>
            <canvas id="camera-canvas" hidden></canvas>
            <button type="button" class="btn btn-primary" id="capture-btn">Capture</button>
          </div>
          <span class="dropzone-text" id="dropzone-text">Drop image here or click to browse</span>
        </div>
      </div>

      <div id="upload-audio-panel" class="upload-type-panel" style="display:none">
        <p class="modal-hint">Upload a file or record up to 30 seconds. MP3, WAV, M4A, WebM supported.</p>
        <div class="upload-source-tabs">
          <button type="button" class="upload-tab active" data-source="upload">Upload file</button>
          <button type="button" class="upload-tab" data-source="record">Record</button>
        </div>
        <div id="sound-upload-panel" class="sound-source-panel">
          <div class="upload-dropzone" id="sound-dropzone">
            <input type="file" id="sound-file-input" accept="audio/*,.mp3,.wav,.ogg,.webm,.m4a,video/*" hidden>
            <span class="dropzone-text" id="sound-dropzone-text">Drop audio or video here or click to browse</span>
          </div>
        </div>
        <div id="sound-record-panel" class="sound-source-panel" style="display:none">
          <div class="record-controls">
            <button type="button" class="btn btn-primary" id="btn-record-start">Start recording</button>
            <button type="button" class="btn btn-ghost" id="btn-record-stop" disabled style="display:none">Stop</button>
            <span id="record-timer" class="record-timer">0:00 / 0:30</span>
          </div>
          <p class="record-hint" id="record-status">Allow microphone access to record.</p>
        </div>
      </div>

      <form id="upload-form">
        <input type="text" id="caption-input" placeholder="Caption (optional)">
        <div class="visibility-wrap">
          <label for="visibility-select">Visibility</label>
          <select id="visibility-select">
            <option value="public">Public (everyone)</option>
            <option value="friends">Friends only</option>
          </select>
        </div>
        <div id="username-wrap">
          <input type="text" id="username-input" placeholder="Username (optional)" value="anonymous">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="cancel-upload">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-upload" disabled>Upload</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- View by hash modal -->
  <dialog class="modal" id="hash-modal">
    <div class="modal-content">
      <button type="button" class="btn-close" id="close-hash" aria-label="Close">Ã—</button>
      <h2>Babelia Lookup</h2>
      <p class="modal-hint">Enter # (number) or 64-char Babelia location. Drop image (HEIC supported) to compute.</p>
      <div class="hash-dropzone" id="hash-dropzone">Drop image to compute Babelia location</div>
      <form id="hash-form">
        <input type="text" id="hash-input" placeholder="# (number) or 64-char location" maxlength="64">
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="cancel-hash">Cancel</button>
          <button type="submit" class="btn btn-primary">Retrieve</button>
        </div>
      </form>
      <div class="hash-result" id="hash-result"></div>
    </div>
  </dialog>

  <!-- Post detail (lightbox) -->
  <dialog class="modal modal-lightbox" id="post-modal">
    <div class="modal-content modal-content-full">
      <button class="btn-close" id="close-post">Ã—</button>
      <div class="lightbox-body" id="lightbox-body"></div>
    </div>
  </dialog>

  <script src="https://unpkg.com/exifr@7/dist/full.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="/hash-util.js"></script>
  <script src="/nav-dropdown.js"></script>
  <script src="/app-common.js"></script>
  <script src="/app.js"></script>
</body>
</html>
