<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tchoff — Hash Database</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .hashes-page { max-width: 900px; margin: 0 auto; padding: 32px 24px; }
    .hashes-page h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .hashes-page .subtitle { color: var(--text-muted); margin-bottom: 24px; }
    .hash-table { width: 100%; border-collapse: collapse; }
    .hash-table th { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; }
    .hash-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.8rem; }
    .hash-table tr:hover { background: var(--bg-card); }
    .hash-table .hash-cell { word-break: break-all; }
    .hash-table .exif-cell { font-size: 0.75rem; max-width: 280px; }
    .hash-table .exif-summary { color: var(--text-muted); cursor: pointer; }
    .hash-table .exif-summary:hover { color: var(--text); }
    .hash-table .exif-detail { margin-top: 8px; font-size: 0.7rem; color: var(--text-muted); line-height: 1.4; }
    .hash-table a { color: var(--accent); text-decoration: none; }
    .hash-table a:hover { text-decoration: underline; }
    .hash-table-wrap { overflow-x: auto; margin-top: 16px; border-radius: var(--radius); border: 1px solid var(--border); }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 24px; text-decoration: none; transition: color 0.2s; }
    .back-link:hover { color: var(--text); }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <a href="/sound.html" class="btn-icon" title="Wall of Sound">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
        </svg>
      </a>
      <a href="/soundboard.html" class="btn-icon" title="Soundboard">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="6" width="4" height="12" rx="1"/>
          <rect x="8" y="4" width="4" height="16" rx="1"/>
          <rect x="14" y="8" width="4" height="8" rx="1"/>
          <rect x="20" y="2" width="2" height="20" rx="1"/>
        </svg>
      </a>
      <a href="/dj.html" class="btn-icon" title="DJ Table">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="8" height="16" rx="1"/>
          <rect x="14" y="4" width="8" height="16" rx="1"/>
          <path d="M10 8h4M10 12h4M10 16h4"/>
        </svg>
      </a>
      <a href="/babel.html" class="btn-icon" title="Babel Library">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="9"/>
          <path d="M12 3v6m0 6v6M3 12h6m6 0h6"/>
          <path d="M5.6 5.6l4.2 4.2m4.4 4.4l4.2 4.2M5.6 18.4l4.2-4.2m4.4-4.4l4.2-4.2"/>
        </svg>
      </a>
      <a href="/hashes.html" class="btn-icon" title="Image hash database" style="text-decoration:none; background: var(--bg-card); border-color: var(--accent);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
      </a>
      <a href="/sound-hashes.html" class="btn-icon" title="Sound hash database">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>
      </a>
      <a href="/" class="btn-icon" title="Feed" style="text-decoration:none">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
        </svg>
      </a>
      <a href="/#upload" class="btn-icon" title="Upload" style="text-decoration:none">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </a>
      <a href="/#hash" class="btn-icon" title="View by hash" style="text-decoration:none">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
      </a>
    </nav>
  </header>

  <main class="hashes-page">
    <a href="/" class="back-link">← Back to feed</a>
    <h1>Image Hash Database</h1>
    <p class="subtitle">All hashes stored in SQLite</p>

    <div id="hash-list">
      <p class="loading">Loading…</p>
    </div>
  </main>

  <script src="/hash-util.js"></script>
  <script>
    async function loadHashes() {
      const el = document.getElementById('hash-list');
      try {
        const res = await fetch('/api/hashes');
        const data = res.ok ? await res.json() : { items: [], count: 0 };
        if (!data.items?.length) {
          el.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon" aria-hidden="true">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <ellipse cx="12" cy="5" rx="9" ry="3"/>
                  <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                  <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
              </div>
              <p>No hashes in database yet. Upload an image from the feed to get started.</p>
            </div>`;
          return;
        }
        el.innerHTML = `
          <p class="subtitle" style="margin-bottom:16px">${data.count} image${data.count !== 1 ? 's' : ''} · Lookup by #, image hash, or Babel hash</p>
          <div class="hash-table-wrap">
          <table class="hash-table">
            <thead><tr><th>Thumb</th><th>#</th><th>Image hash</th><th>Babel hash</th><th>Size</th><th>Upload time</th><th>Origin IP</th><th>EXIF</th><th>View</th></tr></thead>
            <tbody>
              ${data.items.map((item) => {
                const babelHash = item.babelHash || item.imageHash;
                const thumbSrc = item.num ? '/i/n/' + item.num : (babelHash ? '/i/' + babelHash : '');
                const exif = item.exif;
                const summary = exif
                  ? [
                      exif['Image.Make'] || exif.Make,
                      exif['Image.Model'] || exif.Model,
                      exif['Photo.DateTimeOriginal'] || exif['Image.DateTime'] || exif.DateTimeOriginal || exif.CreateDate,
                      (exif['GPSInfo.GPSLatitude'] || exif.Latitude) ? 'GPS' : null
                    ].filter(Boolean).slice(0, 2).join(' · ') || Object.keys(exif).length + ' fields'
                  : '—';
                const detail = exif
                  ? Object.entries(exif).map(([k, v]) => '<div><strong>' + k + '</strong>: ' + v + '</div>').join('')
                  : '';
                const exifHtml = exif
                  ? '<span class="exif-summary" onclick="this.nextElementSibling.hidden=!this.nextElementSibling.hidden">' + summary + '</span><div class="exif-detail" hidden>' + detail + '</div>'
                  : '—';
                const timeStr = item.createdAt ? new Date(item.createdAt).toLocaleString() : '—';
                const ipStr = item.originIp || '—';
                const sizeStr = (item.width && item.height) ? (item.width + '×' + item.height) : '—';
                return '<tr><td>' + (thumbSrc ? '<img src="' + thumbSrc + '" alt="" loading="lazy" style="width:48px;height:48px;object-fit:cover;border-radius:4px">' : '—') + '</td><td>' + item.num + '</td><td class="hash-cell">' + (item.imageHash || '—') + '</td><td class="hash-cell">' + (item.babelHash || '—') + '</td><td>' + sizeStr + '</td><td>' + timeStr + '</td><td>' + ipStr + '</td><td class="exif-cell">' + exifHtml + '</td><td><a href="/i/n/' + item.num + '">By #</a> · <a href="/i/' + (item.babelHash || item.imageHash) + '">By hash</a></td></tr>';
              }).join('')}
            </tbody>
          </table>
          </div>
        `;
      } catch (err) {
        el.innerHTML = '<p class="error">Failed to load hashes.</p>';
      }
    }
    loadHashes();
  </script>
</body>
</html>
