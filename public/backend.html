<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backend ‚Äî Tchoff</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/theme-loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .backend-page { max-width: 900px; margin: 0 auto; padding: 32px 24px; }
    .backend-page h1 { font-size: 1.5rem; margin-bottom: 8px; letter-spacing: -0.02em; }
    .backend-page .subtitle { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; text-decoration: none; }
    .back-link:hover { color: var(--text); }
    .backend-denied { padding: 48px 24px; text-align: center; color: var(--text-muted); }
    .backend-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; }
    .backend-section h2 { font-size: 1.1rem; margin-bottom: 16px; }
    .report-item { padding: 12px 0; border-bottom: 1px solid var(--border); }
    .report-item:last-child { border-bottom: none; }
    .report-meta { font-size: 0.85rem; color: var(--text-muted); }
    .report-reason { font-weight: 500; }
    .report-link { font-size: 0.85rem; }
    .report-link a { color: var(--accent); }
    .report-details { display: grid; gap: 6px 16px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin-top: 8px; }
    .report-detail { font-size: 0.8rem; color: var(--text-muted); }
    .report-detail strong { color: var(--text); }
    .report-actions { display: flex; gap: 8px; align-items: center; margin-top: 8px; flex-wrap: wrap; }
    .contact-item { padding: 12px 0; border-bottom: 1px solid var(--border); }
    .contact-item:last-child { border-bottom: none; }
    .contact-item .contact-from { font-weight: 500; }
    .contact-item .contact-meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .contact-item .contact-message { margin-top: 8px; white-space: pre-wrap; font-size: 0.95rem; }
    .pagination-backend { display: flex; gap: 12px; align-items: center; margin-top: 16px; }
    .bulk-upload-dropzone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 24px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
    .bulk-upload-dropzone:hover, .bulk-upload-dropzone.dragover { border-color: var(--accent); background: var(--bg); }
    .bulk-upload-dropzone p { margin: 0; color: var(--text-muted); font-size: 0.9rem; }
    .bulk-upload-files { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; }
    .bulk-upload-file { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.85rem; }
    .bulk-upload-file img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; }
    .bulk-upload-file .remove { cursor: pointer; color: var(--text-muted); padding: 0 4px; }
    .bulk-upload-file .remove:hover { color: var(--accent); }
    .bulk-upload-actions { margin-top: 16px; display: flex; gap: 12px; align-items: center; }
    .bulk-upload-progress { margin-top: 12px; font-size: 0.9rem; color: var(--text-muted); }
    .bulk-upload-results { margin-top: 16px; font-size: 0.9rem; }
    .bulk-upload-results .ok { color: var(--success, #22c55e); }
    .bulk-upload-results .err { color: var(--error, #ef4444); }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <div class="nav-dropdown-wrap">
        <button type="button" class="btn-icon nav-menu-btn" id="nav-menu-btn" aria-label="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="nav-dropdown" id="nav-dropdown" role="menu">
          <a href="/" role="menuitem">Feed</a>
          <a href="/babel.html" role="menuitem">Babel Library</a>
          <a href="/sound.html" role="menuitem">Wall of Sound</a>
          <a href="/soundboard.html" role="menuitem">Soundboard</a>
          <a href="/dj.html" role="menuitem">DJ Table</a>
          <a href="/movie-maker.html" role="menuitem">Movie Maker</a>
          <a href="/users.html" role="menuitem">Find Friends</a>
          <a href="/hashes.html" role="menuitem">Image Hashes</a>
          <a href="/sound-hashes.html" role="menuitem">Sound Hashes</a>
          <a href="/themes.html" role="menuitem">Themes</a>
          <a href="/#upload" role="menuitem">Upload Image</a>
          <a href="/#upload-audio" role="menuitem">Upload Audio</a>
          <a href="/#hash" role="menuitem">View by Hash</a>
          <a href="/#auth" role="menuitem">Sign in / Account</a>
          <a href="/contact.html" role="menuitem">Contact</a>
          <a href="/terms.html" role="menuitem">Terms of Use</a>
          <a href="/privacy.html" role="menuitem">Privacy Policy</a>
          <a href="/backend.html" class="nav-admin-only" role="menuitem">Backend</a>
        </div>
      </div>
      <button class="btn-icon" id="btn-auth" title="Sign in / Account">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </nav>
  </header>

  <main class="backend-page">
    <a href="/" class="back-link">‚Üê Back to feed</a>
    <h1>Backend</h1>
    <p class="subtitle">Admin dashboard for the tchoff user. View and manage content reports.</p>

    <div id="backend-denied" class="backend-denied" style="display:none">
      <p>Access denied. Sign in as the admin user (tchoff) to access the backend.</p>
      <p><a href="/#auth">Sign in</a></p>
    </div>

    <div id="backend-content" style="display:none">
      <section class="backend-section">
        <h2>Bulk Upload</h2>
        <p class="report-meta" style="margin-bottom:12px">Upload up to 10 images or audio files at once. Images: HEIC, JPEG, PNG, WebP. Audio: WAV, MP3, M4A, WebM (max 30 sec each).</p>
        <div class="bulk-upload-dropzone" id="bulk-dropzone">
          <p>Drop files here or click to browse</p>
          <input type="file" id="bulk-file-input" accept="image/*,audio/*,.heic,.heif,.mp3,.wav,.ogg,.m4a,.webm" multiple hidden>
        </div>
        <div class="bulk-upload-files" id="bulk-files"></div>
        <div class="bulk-upload-actions">
          <button type="button" class="btn btn-primary" id="bulk-upload-btn" disabled>Upload 0 files</button>
        </div>
        <div class="bulk-upload-progress" id="bulk-progress" style="display:none"></div>
        <div class="bulk-upload-results" id="bulk-results"></div>
      </section>
      <section class="backend-section">
        <h2>Contact Messages</h2>
        <div id="contact-list"></div>
        <div class="pagination-backend" id="contact-pagination"></div>
      </section>
      <section class="backend-section">
        <h2>Content Reports</h2>
        <div id="reports-list"></div>
        <div class="pagination-backend" id="reports-pagination"></div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script src="/hash-util.js"></script>
  <script src="/nav-dropdown.js"></script>
  <script>
    const API = '/api';
    function escapeHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    const authToken = localStorage.getItem('tchoff_token');

    document.getElementById('btn-auth')?.addEventListener('click', () => { window.location.href = '/#auth'; });

    async function init() {
      if (!authToken) {
        document.getElementById('backend-denied').style.display = 'block';
        return;
      }
      const checkRes = await fetch(API + '/admin/check', { headers: { Authorization: 'Bearer ' + authToken } });
      const { admin } = await checkRes.json().catch(() => ({ admin: false }));
      if (!admin) {
        document.getElementById('backend-denied').style.display = 'block';
        return;
      }
      document.getElementById('backend-content').style.display = 'block';
      loadContact(1);
      loadReports(1);
    }

    let contactPage = 1;
    async function loadContact(page) {
      contactPage = page;
      const list = document.getElementById('contact-list');
      const pagEl = document.getElementById('contact-pagination');
      list.innerHTML = '<p class="loading">Loading‚Ä¶</p>';
      try {
        const res = await fetch(`${API}/admin/contact?page=${page}&per=20`, { headers: { Authorization: 'Bearer ' + authToken } });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load');
        const items = data.items || [];
        list.innerHTML = items.length === 0
          ? '<p class="report-meta">No contact messages yet.</p>'
          : items.map((c) => `
            <div class="contact-item">
              <div class="contact-from">${c.senderName ? escapeHtml(c.senderName) + ' ' : ''}&lt;${escapeHtml(c.senderEmail)}&gt;${c.senderUsername ? ' ¬∑ @' + escapeHtml(c.senderUsername) : ''}</div>
              ${c.subject ? `<div class="report-meta">Subject: ${escapeHtml(c.subject)}</div>` : ''}
              <div class="contact-meta">${c.createdAt ? new Date(c.createdAt).toLocaleString() : ''}${c.senderIp ? ' ¬∑ IP: ' + escapeHtml(c.senderIp) : ''}</div>
              <div class="contact-message">${escapeHtml(c.message)}</div>
            </div>`).join('');
        const total = data.total ?? 0;
        const per = data.per ?? 20;
        const totalPages = Math.max(1, Math.ceil(total / per));
        pagEl.innerHTML = totalPages <= 1 ? '' : `
          <button type="button" class="btn btn-ghost" ${page <= 1 ? 'disabled' : ''} data-page="${page - 1}">‚Üê Prev</button>
          <span>Page ${page} of ${totalPages}</span>
          <button type="button" class="btn btn-ghost" ${page >= totalPages ? 'disabled' : ''} data-page="${page + 1}">Next ‚Üí</button>
        `;
        pagEl.querySelectorAll('button[data-page]').forEach((b) => {
          b.addEventListener('click', () => loadContact(parseInt(b.dataset.page, 10)));
        });
      } catch (err) {
        list.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    async function loadReports(page) {
      const list = document.getElementById('reports-list');
      const pagEl = document.getElementById('reports-pagination');
      list.innerHTML = '<p class="loading">Loading‚Ä¶</p>';
      try {
        const res = await fetch(`${API}/admin/reports?page=${page}&per=20`, { headers: { Authorization: 'Bearer ' + authToken } });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to load');
        const items = data.items || [];
        list.innerHTML = items.length === 0
          ? '<p class="report-meta">No reports yet.</p>'
          : items.map((r) => {
              const link = r.contentType === 'image'
                ? (r.contentNum ? `/i/n/${r.contentNum}` : r.contentHash ? `/i/${r.contentHash}` : '#')
                : (r.contentNum ? `/s/n/${r.contentNum}` : r.contentHash ? `/sound.html#${r.contentHash}` : '#');
              const linkText = r.contentType === 'image' ? 'View image' : 'View sound';
              const canDisable = (r.contentType === 'image' || r.contentType === 'sound') && !r.isDisabled;
              const disableData = JSON.stringify({ type: r.contentType, num: r.contentNum, hash: r.contentHash });
              return `
                <div class="report-item" data-report-id="${r.id}">
                  <div>
                    <span class="report-reason">${r.reason}</span>
                    <span class="report-meta"> ¬∑ ${r.contentType} #${r.contentNum || r.contentHash?.slice(0, 12) || '?'}</span>
                    ${r.isDisabled ? '<span class="report-meta" style="color:var(--text-muted)">(disabled)</span>' : ''}
                  </div>
                  <div class="report-meta">Reported by @${r.reporterUsername} ¬∑ ${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}</div>
                  ${r.details ? `<div class="report-meta">Details: ${escapeHtml(r.details)}</div>` : ''}
                  <div class="report-details">
                    <div class="report-detail"><strong>Poster:</strong> @${r.posterUsername}</div>
                    <div class="report-detail"><strong>Post origin IP:</strong> ${r.postOriginIp || '‚Äî'}</div>
                    <div class="report-detail"><strong>Reporter IP:</strong> ${r.reporterIp || '‚Äî'}</div>
                  </div>
                  <div class="report-actions">
                    <div class="report-link"><a href="${link}" target="_blank" rel="noopener">${linkText} ‚Üí</a></div>
                    ${canDisable ? `<button type="button" class="btn btn-ghost btn-disable-report" data-payload='${disableData.replace(/'/g, '&#39;')}' title="Hide from all users">Disable</button>` : ''}
                  </div>
                </div>`;
            }).join('');
        list.querySelectorAll('.btn-disable-report').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const payload = JSON.parse(btn.dataset.payload || '{}');
            btn.disabled = true;
            btn.textContent = '‚Ä¶';
            try {
              const res = await fetch(API + '/admin/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
                body: JSON.stringify({ contentType: payload.type, num: payload.num, hash: payload.hash }),
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Failed');
              loadReports(page);
            } catch (err) {
              alert(err.message);
              btn.disabled = false;
              btn.textContent = 'Disable';
            }
          });
        });
        const total = data.total ?? 0;
        const per = data.per ?? 20;
        const totalPages = Math.max(1, Math.ceil(total / per));
        pagEl.innerHTML = totalPages <= 1 ? '' : `
          <button type="button" class="btn btn-ghost" ${page <= 1 ? 'disabled' : ''} data-page="${page - 1}">‚Üê Prev</button>
          <span>Page ${page} of ${totalPages}</span>
          <button type="button" class="btn btn-ghost" ${page >= totalPages ? 'disabled' : ''} data-page="${page + 1}">Next ‚Üí</button>
        `;
        pagEl.querySelectorAll('button').forEach((b) => {
          b.addEventListener('click', () => loadReports(parseInt(b.dataset.page, 10)));
        });
      } catch (err) {
        list.innerHTML = `<p class="error">${err.message}</p>`;
      }
    }

    init();

    // Bulk upload (admin only)
    const MAX_BULK = 10;
    let bulkFiles = [];

    function isImageFile(f) {
      if (!f) return false;
      const t = (f.type || '').toLowerCase();
      const n = (f.name || '').toLowerCase();
      return t.startsWith('image/') || /\.(heic|heif)$/.test(n);
    }
    function isAudioFile(f) {
      if (!f) return false;
      const t = (f.type || '').toLowerCase();
      const n = (f.name || '').toLowerCase();
      return t.startsWith('audio/') || t.startsWith('video/') || /\.(mp3|wav|ogg|webm|m4a|mp4)$/i.test(n);
    }

    const bulkDropzone = document.getElementById('bulk-dropzone');
    const bulkFileInput = document.getElementById('bulk-file-input');
    const bulkFilesEl = document.getElementById('bulk-files');
    const bulkBtn = document.getElementById('bulk-upload-btn');
    const bulkProgress = document.getElementById('bulk-progress');
    const bulkResults = document.getElementById('bulk-results');

    bulkDropzone.addEventListener('click', () => bulkFileInput?.click());
    bulkDropzone.addEventListener('dragover', (e) => { e.preventDefault(); bulkDropzone.classList.add('dragover'); });
    bulkDropzone.addEventListener('dragleave', () => bulkDropzone.classList.remove('dragover'));
    bulkDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      bulkDropzone.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files).filter((f) => isImageFile(f) || isAudioFile(f));
      addBulkFiles(files);
    });
    bulkFileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []).filter((f) => isImageFile(f) || isAudioFile(f));
      addBulkFiles(files);
      e.target.value = '';
    });

    function addBulkFiles(files) {
      for (const f of files) {
        if (bulkFiles.length >= MAX_BULK) break;
        bulkFiles.push(f);
      }
      renderBulkFiles();
    }

    function removeBulkFile(index) {
      bulkFiles.splice(index, 1);
      renderBulkFiles();
    }

    function renderBulkFiles() {
      bulkFilesEl.innerHTML = bulkFiles.map((f, i) => {
        const icon = isImageFile(f)
          ? `<img src="${URL.createObjectURL(f)}" alt="" onload="URL.revokeObjectURL(this.src)">`
          : '<span aria-hidden="true">üéµ</span>';
        return `<div class="bulk-upload-file" data-index="${i}">${icon}<span>${escapeHtml(f.name)}</span><span class="remove" data-index="${i}" aria-label="Remove">√ó</span></div>`;
      }).join('');
      bulkFilesEl.querySelectorAll('.remove').forEach((el) => {
        el.addEventListener('click', (e) => { e.stopPropagation(); removeBulkFile(parseInt(el.dataset.index, 10)); });
      });
      bulkBtn.disabled = bulkFiles.length === 0;
      bulkBtn.textContent = `Upload ${bulkFiles.length} file${bulkFiles.length !== 1 ? 's' : ''}`;
    }

    bulkBtn.addEventListener('click', async () => {
      if (bulkFiles.length === 0 || !authToken) return;
      bulkBtn.disabled = true;
      bulkProgress.style.display = '';
      bulkResults.innerHTML = '';
      const results = [];
      for (let i = 0; i < bulkFiles.length; i++) {
        const f = bulkFiles[i];
        bulkProgress.textContent = `Processing ${i + 1}/${bulkFiles.length}: ${f.name}‚Ä¶`;
        try {
          if (isImageFile(f)) {
            bulkProgress.textContent = `Computing hash ${i + 1}/${bulkFiles.length}‚Ä¶`;
            const compat = await (typeof ensureCanvasCompatible === 'function' ? ensureCanvasCompatible(f) : Promise.resolve(f));
            const [imageHash, babelia] = await Promise.all([hashImageAtSize(compat), computeBabelia(compat)]);
            const { babelHash, pngBlob, width: bw, height: bh } = babelia;
            const pngBase64 = await new Promise((res) => {
              const r = new FileReader();
              r.onload = () => res(r.result?.split(',')[1] || null);
              r.readAsDataURL(pngBlob);
            });
            bulkProgress.textContent = `Uploading ${i + 1}/${bulkFiles.length}‚Ä¶`;
            const form = new FormData();
            form.append('image', f);
            form.append('imageHash', imageHash);
            form.append('babelHash', babelHash);
            form.append('babeliaPng', pngBase64 || 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==');
            form.append('width', String(bw || ''));
            form.append('height', String(bh || ''));
            form.append('caption', '');
            form.append('visibility', 'public');
            const res = await fetch(API + '/upload', { method: 'POST', headers: { Authorization: 'Bearer ' + authToken }, body: form });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data.success) results.push({ name: f.name, ok: true, url: data.url || data.urlNum });
            else results.push({ name: f.name, ok: false, err: data.error || res.statusText });
          } else {
            const objectUrl = URL.createObjectURL(f);
            const duration = await new Promise((res) => {
              const a = new Audio();
              a.onloadedmetadata = () => res(a.duration);
              a.onerror = () => res(0);
              a.src = objectUrl;
            });
            URL.revokeObjectURL(objectUrl);
            if (duration > 30) {
              results.push({ name: f.name, ok: false, err: 'Audio must be 30 seconds or less' });
            } else {
              bulkProgress.textContent = `Uploading ${i + 1}/${bulkFiles.length}‚Ä¶`;
              const form = new FormData();
              form.append('audio', f);
              form.append('caption', '');
              form.append('visibility', 'public');
              form.append('duration', Math.round(duration));
              const res = await fetch(API + '/upload-sound', { method: 'POST', headers: { Authorization: 'Bearer ' + authToken }, body: form });
              const data = await res.json().catch(() => ({}));
              if (res.ok && data.success) results.push({ name: f.name, ok: true, url: data.url || data.urlNum });
              else results.push({ name: f.name, ok: false, err: data.error || res.statusText });
            }
          }
        } catch (err) {
          results.push({ name: f.name, ok: false, err: err.message });
        }
      }
      bulkProgress.style.display = 'none';
      bulkFiles = [];
      renderBulkFiles();
      bulkBtn.disabled = false;
      bulkResults.innerHTML = results.map((r) =>
        r.ok ? `<div class="ok">‚úì ${escapeHtml(r.name)}</div>` : `<div class="err">‚úó ${escapeHtml(r.name)}: ${escapeHtml(r.err)}</div>`
      ).join('');
    });
  </script>
</body>
</html>
