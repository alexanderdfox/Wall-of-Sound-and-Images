<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suggestions — Tchoff</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/theme-loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .suggestions-page { max-width: 600px; margin: 0 auto; padding: 40px 24px 60px; }
    .suggestions-page h1 { font-size: 1.75rem; margin-bottom: 8px; letter-spacing: -0.02em; }
    .suggestions-page .subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; }
    .suggestions-form { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 32px; }
    .suggestions-form textarea { width: 100%; padding: 12px; min-height: 80px; resize: vertical; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: var(--font-sans); }
    .suggestions-form .form-row { display: flex; gap: 12px; align-items: flex-start; margin-top: 12px; }
    .suggestions-form .form-row .btn { flex-shrink: 0; }
    .suggestions-form .error { color: var(--danger); font-size: 0.9rem; margin-top: 8px; }
    .suggestion-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; display: flex; gap: 16px; align-items: flex-start; }
    .suggestion-vote-col { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .suggestion-vote-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); cursor: pointer; transition: color 0.15s, border-color 0.15s; }
    .suggestion-vote-btn:hover:not(:disabled) { color: var(--accent); border-color: var(--accent); }
    .suggestion-vote-btn.voted { background: var(--accent-muted); color: var(--accent); border-color: var(--accent); }
    .suggestion-vote-btn:disabled { cursor: default; opacity: 0.7; }
    .suggestion-vote-count { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .suggestion-body { flex: 1; min-width: 0; }
    .suggestion-item .idea { font-size: 1rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .suggestion-item .meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 10px; }
    .suggestions-sort { display: flex; gap: 8px; margin-bottom: 16px; }
    .suggestions-sort button { padding: 8px 16px; font-size: 0.9rem; border: 1px solid var(--border); border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); cursor: pointer; }
    .suggestions-sort button:hover { color: var(--text); }
    .suggestions-sort button.active { background: var(--accent-muted); color: var(--accent); border-color: var(--accent); }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem; text-decoration: none; }
    .back-link:hover { color: var(--text); }
    .suggestions-empty { text-align: center; padding: 32px; color: var(--text-muted); }
    .suggestions-pagination { display: flex; gap: 12px; align-items: center; margin-top: 24px; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <div class="nav-dropdown-wrap">
        <button type="button" class="btn-icon nav-menu-btn" id="nav-menu-btn" aria-label="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="nav-dropdown" id="nav-dropdown" role="menu">
          <a href="/" role="menuitem">Feed</a>
          <a href="/babel.html" role="menuitem">Babel Library</a>
          <a href="/sound.html" role="menuitem">Wall of Sound</a>
          <a href="/soundboard.html" role="menuitem">Soundboard</a>
          <a href="/dj.html" role="menuitem">DJ Table</a>
          <a href="/movie-maker.html" role="menuitem">Movie Maker</a>
          <a href="/draw/" role="menuitem">Draw</a>
          <a href="/users.html" role="menuitem">Find Friends</a>
          <a href="/suggestions.html" role="menuitem">Suggestions</a>
          <a href="/plans.html" role="menuitem">Plans</a>
          <a href="/hashes.html" role="menuitem">Image Hashes</a>
          <a href="/sound-hashes.html" role="menuitem">Sound Hashes</a>
          <a href="/themes.html" role="menuitem">Themes</a>
          <a href="/#upload" role="menuitem">Upload Image</a>
          <a href="/#upload-audio" role="menuitem">Upload Audio</a>
          <a href="/#hash" role="menuitem">View by Hash</a>
          <a href="/#auth" role="menuitem">Sign in / Account</a>
          <a href="/contact.html" role="menuitem">Contact</a>
          <a href="/terms.html" role="menuitem">Terms of Use</a>
          <a href="/privacy.html" role="menuitem">Privacy Policy</a>
          <a href="/backend.html" class="nav-admin-only" role="menuitem">Backend</a>
        </div>
      </div>
      <button class="btn-icon" id="btn-auth" title="Sign in / Account">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </nav>
  </header>

  <main class="suggestions-page">
    <a href="/" class="back-link">← Back to feed</a>
    <h1>Suggestions</h1>
    <p class="subtitle">Share ideas for Tchoff. Everyone can submit and view suggestions.</p>

    <form id="suggestions-form" class="suggestions-form">
      <textarea id="suggestion-idea" placeholder="Your idea (features, improvements, fixes…)…" maxlength="500" required></textarea>
      <div class="form-row">
        <button type="submit" class="btn btn-primary">Submit</button>
        <span id="suggestion-error" class="error" style="display:none"></span>
      </div>
    </form>

    <h2 style="font-size:1.1rem;margin-bottom:8px">Ideas</h2>
    <div class="suggestions-sort">
      <button type="button" id="sort-popular" class="active">Most Popular</button>
      <button type="button" id="sort-newest">Newest</button>
    </div>
    <div id="suggestions-list"></div>
    <div class="suggestions-pagination" id="suggestions-pagination"></div>
  </main>

  <script src="/nav-dropdown.js"></script>
  <script src="/emoji-data.js"></script>
  <script src="/shoot.js"></script>
  <script>
    const API = '/api';
    const authToken = localStorage.getItem('tchoff_token');

    function escapeHtml(s) {
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    document.getElementById('btn-auth')?.addEventListener('click', () => { window.location.href = '/#auth'; });

    let currentSort = 'popular';
    let currentPage = 1;

    document.getElementById('sort-popular').addEventListener('click', () => { currentSort = 'popular'; currentPage = 1; updateSortButtons(); loadSuggestions(1); });
    document.getElementById('sort-newest').addEventListener('click', () => { currentSort = 'newest'; currentPage = 1; updateSortButtons(); loadSuggestions(1); });

    function updateSortButtons() {
      document.getElementById('sort-popular').classList.toggle('active', currentSort === 'popular');
      document.getElementById('sort-newest').classList.toggle('active', currentSort === 'newest');
    }

    document.getElementById('suggestions-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errEl = document.getElementById('suggestion-error');
      errEl.style.display = 'none';
      const idea = document.getElementById('suggestion-idea').value.trim();
      if (!idea || idea.length < 3) {
        errEl.textContent = 'Idea must be at least 3 characters';
        errEl.style.display = 'inline';
        return;
      }
      try {
        const res = await fetch(API + '/suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(authToken ? { Authorization: 'Bearer ' + authToken } : {}) },
          body: JSON.stringify({ idea }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to submit');
        document.getElementById('suggestion-idea').value = '';
        loadSuggestions(1);
      } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = 'inline';
      }
    });

    async function loadSuggestions(page) {
      currentPage = page;
      const listEl = document.getElementById('suggestions-list');
      const pagEl = document.getElementById('suggestions-pagination');
      listEl.innerHTML = '<p class="loading">Loading…</p>';
      try {
        const url = `${API}/suggestions?page=${page}&per=20&sort=${currentSort}`;
        const headers = authToken ? { Authorization: 'Bearer ' + authToken } : {};
        const res = await fetch(url, { headers });
        const data = await res.json();
        const items = data.items || [];
        listEl.innerHTML = items.length === 0
          ? '<div class="suggestions-empty"><p>No suggestions yet. Be the first!</p></div>'
          : items.map((s) => renderSuggestion(s)).join('');
        listEl.querySelectorAll('.suggestion-vote-btn').forEach((btn) => {
          if (btn.dataset.signin) {
            btn.addEventListener('click', () => { window.location.href = '/#auth'; });
          } else {
            btn.addEventListener('click', () => handleVote(btn));
          }
        });
        const total = data.total ?? 0;
        const per = data.per ?? 20;
        const totalPages = Math.max(1, Math.ceil(total / per));
        pagEl.innerHTML = totalPages <= 1 ? '' : `
          <button type="button" class="btn btn-ghost" ${page <= 1 ? 'disabled' : ''} data-page="${Math.max(1, page - 1)}">← Prev</button>
          <span>Page ${page} of ${totalPages}</span>
          <button type="button" class="btn btn-ghost" ${page >= totalPages ? 'disabled' : ''} data-page="${Math.min(totalPages, page + 1)}">Next →</button>
        `;
        pagEl.querySelectorAll('button[data-page]').forEach((b) => {
          b.addEventListener('click', () => loadSuggestions(parseInt(b.dataset.page, 10)));
        });
      } catch (err) {
        listEl.innerHTML = '<p class="error">' + escapeHtml(err.message) + '</p>';
      }
    }

    function renderSuggestion(s) {
      const votes = Number(s.votes) ?? 0;
      const voted = !!(s.voted);
      const canVote = !!authToken;
      const voteBtn = canVote
        ? `<button type="button" class="suggestion-vote-btn ${voted ? 'voted' : ''}" data-id="${escapeHtml(s.id)}" title="${voted ? 'Remove upvote' : 'Upvote'}" aria-label="${voted ? 'Remove upvote' : 'Upvote'}">▲</button>`
        : `<button type="button" class="suggestion-vote-btn" data-signin title="Sign in to vote">▲</button>`;
      return `
        <div class="suggestion-item">
          <div class="suggestion-vote-col">
            ${voteBtn}
            <span class="suggestion-vote-count">${votes}</span>
          </div>
          <div class="suggestion-body">
            <div class="idea">${escapeHtml(s.idea)}</div>
            <div class="meta">${escapeHtml(s.author || 'Anonymous')} · ${s.createdAt ? new Date(s.createdAt).toLocaleDateString() : ''}</div>
          </div>
        </div>`;
    }

    async function handleVote(btn) {
      const id = btn.dataset.id;
      if (!id || !authToken) return;
      btn.disabled = true;
      try {
        const res = await fetch(`${API}/suggestions/${id}/vote`, {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + authToken },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to vote');
        const countEl = btn.closest('.suggestion-vote-col')?.querySelector('.suggestion-vote-count');
        if (countEl) countEl.textContent = String(data.votes ?? 0);
        btn.classList.toggle('voted', !!data.voted);
      } catch (err) {
        if (err.message === 'Sign in to vote') window.location.href = '/#auth';
        else alert(err.message);
      } finally {
        btn.disabled = false;
      }
    }

    loadSuggestions(1);
  </script>
</body>
</html>
