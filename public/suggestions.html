<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Suggestions — Tchoff</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/theme-loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .suggestions-page { max-width: 600px; margin: 0 auto; padding: 40px 24px 60px; }
    .suggestions-page h1 { font-size: 1.75rem; margin-bottom: 8px; letter-spacing: -0.02em; }
    .suggestions-page .subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px; }
    .suggestions-form { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 32px; }
    .suggestions-form textarea { width: 100%; padding: 12px; min-height: 80px; resize: vertical; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: var(--font-sans); }
    .suggestions-form .form-row { display: flex; gap: 12px; align-items: flex-start; margin-top: 12px; }
    .suggestions-form .form-row .btn { flex-shrink: 0; }
    .suggestions-form .error { color: var(--danger); font-size: 0.9rem; margin-top: 8px; }
    .suggestion-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
    .suggestion-item .idea { font-size: 1rem; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .suggestion-item .meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 10px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 24px; font-size: 0.95rem; text-decoration: none; }
    .back-link:hover { color: var(--text); }
    .suggestions-empty { text-align: center; padding: 32px; color: var(--text-muted); }
    .suggestions-pagination { display: flex; gap: 12px; align-items: center; margin-top: 24px; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <div class="nav-dropdown-wrap">
        <button type="button" class="btn-icon nav-menu-btn" id="nav-menu-btn" aria-label="Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="nav-dropdown" id="nav-dropdown" role="menu">
          <a href="/" role="menuitem">Feed</a>
          <a href="/babel.html" role="menuitem">Babel Library</a>
          <a href="/sound.html" role="menuitem">Wall of Sound</a>
          <a href="/soundboard.html" role="menuitem">Soundboard</a>
          <a href="/dj.html" role="menuitem">DJ Table</a>
          <a href="/movie-maker.html" role="menuitem">Movie Maker</a>
          <a href="/users.html" role="menuitem">Find Friends</a>
          <a href="/suggestions.html" role="menuitem">Suggestions</a>
          <a href="/hashes.html" role="menuitem">Image Hashes</a>
          <a href="/sound-hashes.html" role="menuitem">Sound Hashes</a>
          <a href="/themes.html" role="menuitem">Themes</a>
          <a href="/#upload" role="menuitem">Upload Image</a>
          <a href="/#upload-audio" role="menuitem">Upload Audio</a>
          <a href="/#hash" role="menuitem">View by Hash</a>
          <a href="/#auth" role="menuitem">Sign in / Account</a>
          <a href="/contact.html" role="menuitem">Contact</a>
          <a href="/terms.html" role="menuitem">Terms of Use</a>
          <a href="/privacy.html" role="menuitem">Privacy Policy</a>
          <a href="/backend.html" class="nav-admin-only" role="menuitem">Backend</a>
        </div>
      </div>
      <button class="btn-icon" id="btn-auth" title="Sign in / Account">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </button>
    </nav>
  </header>

  <main class="suggestions-page">
    <a href="/" class="back-link">← Back to feed</a>
    <h1>Suggestions</h1>
    <p class="subtitle">Share ideas for Tchoff. Everyone can submit and view suggestions.</p>

    <form id="suggestions-form" class="suggestions-form">
      <textarea id="suggestion-idea" placeholder="Your idea (features, improvements, fixes…)…" maxlength="500" required></textarea>
      <div class="form-row">
        <button type="submit" class="btn btn-primary">Submit</button>
        <span id="suggestion-error" class="error" style="display:none"></span>
      </div>
    </form>

    <h2 style="font-size:1.1rem;margin-bottom:16px">Ideas</h2>
    <div id="suggestions-list"></div>
    <div class="suggestions-pagination" id="suggestions-pagination"></div>
  </main>

  <script src="/nav-dropdown.js"></script>
  <script>
    const API = '/api';
    const authToken = localStorage.getItem('tchoff_token');

    function escapeHtml(s) {
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    document.getElementById('btn-auth')?.addEventListener('click', () => { window.location.href = '/#auth'; });

    document.getElementById('suggestions-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errEl = document.getElementById('suggestion-error');
      errEl.style.display = 'none';
      const idea = document.getElementById('suggestion-idea').value.trim();
      if (!idea || idea.length < 3) {
        errEl.textContent = 'Idea must be at least 3 characters';
        errEl.style.display = 'inline';
        return;
      }
      try {
        const res = await fetch(API + '/suggestions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(authToken ? { Authorization: 'Bearer ' + authToken } : {}) },
          body: JSON.stringify({ idea }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed to submit');
        document.getElementById('suggestion-idea').value = '';
        loadSuggestions(1);
      } catch (err) {
        errEl.textContent = err.message;
        errEl.style.display = 'inline';
      }
    });

    async function loadSuggestions(page) {
      const listEl = document.getElementById('suggestions-list');
      const pagEl = document.getElementById('suggestions-pagination');
      listEl.innerHTML = '<p class="loading">Loading…</p>';
      try {
        const res = await fetch(`${API}/suggestions?page=${page}&per=20`);
        const data = await res.json();
        const items = data.items || [];
        listEl.innerHTML = items.length === 0
          ? '<div class="suggestions-empty"><p>No suggestions yet. Be the first!</p></div>'
          : items.map((s) => `
              <div class="suggestion-item">
                <div class="idea">${escapeHtml(s.idea)}</div>
                <div class="meta">${escapeHtml(s.author || 'Anonymous')} · ${s.createdAt ? new Date(s.createdAt).toLocaleDateString() : ''}</div>
              </div>`).join('');
        const total = data.total ?? 0;
        const per = data.per ?? 20;
        const totalPages = Math.max(1, Math.ceil(total / per));
        pagEl.innerHTML = totalPages <= 1 ? '' : `
          <button type="button" class="btn btn-ghost" ${page <= 1 ? 'disabled' : ''} data-page="${Math.max(1, page - 1)}">← Prev</button>
          <span>Page ${page} of ${totalPages}</span>
          <button type="button" class="btn btn-ghost" ${page >= totalPages ? 'disabled' : ''} data-page="${Math.min(totalPages, page + 1)}">Next →</button>
        `;
        pagEl.querySelectorAll('button[data-page]').forEach((b) => {
          b.addEventListener('click', () => loadSuggestions(parseInt(b.dataset.page, 10)));
        });
      } catch (err) {
        listEl.innerHTML = '<p class="error">' + escapeHtml(err.message) + '</p>';
      }
    }

    loadSuggestions(1);
  </script>
</body>
</html>
