<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DJ Table — Tchoff</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .dj-page { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    .dj-page h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 4px; letter-spacing: -0.02em; }
    .dj-page .subtitle { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }
    .dj-table {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      align-items: stretch;
    }
    @media (max-width: 767px) {
      .dj-table { grid-template-columns: 1fr; }
    }
    .dj-deck {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .dj-deck-left { border-left: 3px solid #3b82f6; }
    .dj-deck-right { border-left: 3px solid #ef4444; }
    .dj-deck h2 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
    .dj-deck h2.left { color: #3b82f6; }
    .dj-deck h2.right { color: #ef4444; }
    .dj-hash-input {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      width: 100%;
    }
    .dj-hash-input:focus { outline: none; border-color: var(--accent); }
    .dj-hash-input::placeholder { color: var(--text-muted); }
    .dj-deck-btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .dj-deck-btns button {
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      cursor: pointer;
      font-family: var(--font-sans);
    }
    .dj-deck-btns button:hover { background: var(--border); }
    .dj-deck-btns button.primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .dj-deck-btns button.primary:hover { background: var(--accent-hover); }
    .dj-crossfader-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 80px;
    }
    .dj-crossfader-label { font-size: 0.75rem; color: var(--text-muted); }
    .dj-crossfader {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      min-height: 24px;
      background: linear-gradient(to right, #3b82f6, #ef4444);
      border-radius: 12px;
      outline: none;
    }
    .dj-crossfader::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--text);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .dj-crossfader::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--text);
      cursor: pointer;
      border: none;
    }
    .dj-status { font-size: 0.8rem; color: var(--text-muted); min-height: 1.2em; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; text-decoration: none; }
    .back-link:hover { color: var(--text); }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <a href="/babel.html" class="btn-icon" title="Babel Library">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="9"/>
          <path d="M12 3v6m0 6v6M3 12h6m6 0h6"/>
          <path d="M5.6 5.6l4.2 4.2m4.4 4.4l4.2 4.2M5.6 18.4l4.2-4.2m4.4-4.4l4.2-4.2"/>
        </svg>
      </a>
      <a href="/sound.html" class="btn-icon" title="Wall of Sound">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
        </svg>
      </a>
      <a href="/soundboard.html" class="btn-icon" title="Soundboard">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="6" width="4" height="12" rx="1"/>
          <rect x="8" y="4" width="4" height="16" rx="1"/>
          <rect x="14" y="8" width="4" height="8" rx="1"/>
          <rect x="20" y="2" width="2" height="20" rx="1"/>
        </svg>
      </a>
      <a href="/dj.html" class="btn-icon" title="DJ Table" style="background:var(--bg-card);border-color:var(--accent)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="8" height="16" rx="1"/>
          <rect x="14" y="4" width="8" height="16" rx="1"/>
          <line x1="6" y1="12" x2="6" y2="12"/>
          <line x1="18" y1="12" x2="18" y2="12"/>
          <path d="M10 8h4M10 12h4M10 16h4"/>
        </svg>
      </a>
      <a href="/hashes.html" class="btn-icon" title="Image hash database">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
      </a>
      <a href="/sound-hashes.html" class="btn-icon" title="Sound hash database">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>
      </a>
    </nav>
  </header>

  <main class="dj-page">
    <a href="/" class="back-link">← Back</a>
    <h1>DJ Table</h1>
    <p class="subtitle">Mix Wall of Sound clips. Left and right decks by hash. Crossfader blends between them.</p>

    <div class="dj-table">
      <div class="dj-deck dj-deck-left">
        <h2 class="left">Left Deck</h2>
        <input type="text" class="dj-hash-input" id="hash-left" placeholder="64 hex chars (0-9, a-f)" maxlength="64" spellcheck="false">
        <div class="dj-deck-btns">
          <button type="button" class="primary" id="play-left">Play</button>
          <button type="button" id="stop-left">Stop</button>
          <button type="button" id="random-left">Random</button>
          <button type="button" id="prev-left">← Prev</button>
          <button type="button" id="next-left">Next →</button>
        </div>
        <span class="dj-status" id="status-left"></span>
      </div>

      <div class="dj-crossfader-wrap">
        <span class="dj-crossfader-label">Crossfader</span>
        <input type="range" class="dj-crossfader" id="crossfader" min="0" max="100" value="50" title="Blend: left ← → right">
      </div>

      <div class="dj-deck dj-deck-right">
        <h2 class="right">Right Deck</h2>
        <input type="text" class="dj-hash-input" id="hash-right" placeholder="64 hex chars (0-9, a-f)" maxlength="64" spellcheck="false">
        <div class="dj-deck-btns">
          <button type="button" class="primary" id="play-right">Play</button>
          <button type="button" id="stop-right">Stop</button>
          <button type="button" id="random-right">Random</button>
          <button type="button" id="prev-right">← Prev</button>
          <button type="button" id="next-right">Next →</button>
        </div>
        <span class="dj-status" id="status-right"></span>
      </div>
    </div>
  </main>

  <script src="/hash-util.js"></script>
  <script>
    const hashLeft = document.getElementById('hash-left');
    const hashRight = document.getElementById('hash-right');
    const crossfader = document.getElementById('crossfader');
    const statusLeft = document.getElementById('status-left');
    const statusRight = document.getElementById('status-right');

    let ctx = null;
    let leftGain = null, rightGain = null;
    const audioLeft = new Audio();
    const audioRight = new Audio();

    function initAudioContext() {
      if (ctx) return ctx;
      ctx = new (window.AudioContext || window.webkitAudioContext)();
      const leftDest = ctx.createMediaElementSource(audioLeft);
      const rightDest = ctx.createMediaElementSource(audioRight);
      leftGain = ctx.createGain();
      rightGain = ctx.createGain();
      const merger = ctx.createChannelMerger(2);
      leftDest.connect(leftGain);
      leftGain.connect(merger, 0, 0);
      rightDest.connect(rightGain);
      rightGain.connect(merger, 0, 1);
      merger.connect(ctx.destination);
      updateCrossfader();
      return ctx;
    }

    function updateCrossfader() {
      const pos = parseInt(crossfader.value, 10) / 100;
      if (leftGain) leftGain.gain.value = 1 - pos;
      if (rightGain) rightGain.gain.value = pos;
    }

    crossfader.addEventListener('input', updateCrossfader);

    function normHash(val) {
      return String(val || '').toLowerCase().replace(/[^a-f0-9]/g, '').padStart(64, '0').slice(-64);
    }

    function loadDeck(side, hash) {
      const h = normHash(hash);
      if (h.length !== 64) return false;
      const el = side === 'left' ? audioLeft : audioRight;
      const status = side === 'left' ? statusLeft : statusRight;
      el.src = `/s/${h}`;
      el.load();
      status.textContent = 'Loaded';
      return true;
    }

    function playDeck(side) {
      initAudioContext();
      if (ctx.state === 'suspended') ctx.resume();
      const el = side === 'left' ? audioLeft : audioRight;
      const hashEl = side === 'left' ? hashLeft : hashRight;
      const statusEl = side === 'left' ? statusLeft : statusRight;
      if (!loadDeck(side, hashEl.value)) {
        const h = typeof randomBabelHash === 'function' ? randomBabelHash() : '0'.repeat(64);
        hashEl.value = h;
        loadDeck(side, h);
      }
      el.play().catch((e) => { statusEl.textContent = 'Play failed: ' + (e.message || 'user interaction needed'); });
      statusEl.textContent = 'Playing';
    }

    function stopDeck(side) {
      const el = side === 'left' ? audioLeft : audioRight;
      const status = side === 'left' ? statusLeft : statusRight;
      el.pause();
      el.currentTime = 0;
      status.textContent = 'Stopped';
    }

    document.getElementById('play-left').addEventListener('click', () => playDeck('left'));
    document.getElementById('play-right').addEventListener('click', () => playDeck('right'));
    document.getElementById('stop-left').addEventListener('click', () => stopDeck('left'));
    document.getElementById('stop-right').addEventListener('click', () => stopDeck('right'));

    function deckHash(side) {
      const el = side === 'left' ? hashLeft : hashRight;
      return normHash(el.value) || '0'.repeat(64);
    }

    document.getElementById('random-left').addEventListener('click', () => {
      const h = typeof randomBabelHash === 'function' ? randomBabelHash() : '0'.repeat(64);
      hashLeft.value = h;
      loadDeck('left', h);
    });
    document.getElementById('random-right').addEventListener('click', () => {
      const h = typeof randomBabelHash === 'function' ? randomBabelHash() : '0'.repeat(64);
      hashRight.value = h;
      loadDeck('right', h);
    });

    document.getElementById('prev-left').addEventListener('click', () => {
      const prev = typeof decrementBabelHash === 'function' ? decrementBabelHash(deckHash('left')) : null;
      if (prev) { hashLeft.value = prev; loadDeck('left', prev); }
    });
    document.getElementById('next-left').addEventListener('click', () => {
      const next = typeof incrementBabelHash === 'function' ? incrementBabelHash(deckHash('left')) : null;
      if (next) { hashLeft.value = next; loadDeck('left', next); }
    });
    document.getElementById('prev-right').addEventListener('click', () => {
      const prev = typeof decrementBabelHash === 'function' ? decrementBabelHash(deckHash('right')) : null;
      if (prev) { hashRight.value = prev; loadDeck('right', prev); }
    });
    document.getElementById('next-right').addEventListener('click', () => {
      const next = typeof incrementBabelHash === 'function' ? incrementBabelHash(deckHash('right')) : null;
      if (next) { hashRight.value = next; loadDeck('right', next); }
    });

    hashLeft.addEventListener('change', () => loadDeck('left', hashLeft.value));
    hashRight.addEventListener('change', () => loadDeck('right', hashRight.value));
    hashLeft.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadDeck('left', hashLeft.value); });
    hashRight.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadDeck('right', hashRight.value); });

    audioLeft.addEventListener('ended', () => { statusLeft.textContent = 'Ended'; });
    audioRight.addEventListener('ended', () => { statusRight.textContent = 'Ended'; });

    const defaultHash = '0'.repeat(64);
    hashLeft.value = defaultHash;
    hashRight.value = '1' + '0'.repeat(63);
    loadDeck('left', defaultHash);
    loadDeck('right', hashRight.value);
  </script>
</body>
</html>
