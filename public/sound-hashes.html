<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tchoff — Sound Hash Database</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/theme-loader.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .sound-hashes-page { max-width: 1000px; margin: 0 auto; padding: 32px 24px; }
    .sound-hashes-page h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .sound-hashes-page .subtitle { color: var(--text-muted); margin-bottom: 24px; }
    .sh-table { width: 100%; border-collapse: collapse; }
    .sh-table th { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; }
    .sh-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.8rem; vertical-align: middle; }
    .sh-table tr:hover { background: var(--bg-card); }
    .sh-table .hash-cell { word-break: break-all; }
    .sh-table a { color: var(--accent); text-decoration: none; }
    .sh-table a:hover { text-decoration: underline; }
    .sh-table-wrap { overflow-x: auto; margin-top: 16px; border-radius: var(--radius); border: 1px solid var(--border); }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 24px; text-decoration: none; transition: color 0.2s; }
    .back-link:hover { color: var(--text); }
    .sh-play-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--bg);
      cursor: pointer;
    }
    .sh-play-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <div class="nav-dropdown-wrap">
        <button type="button" class="btn-icon nav-menu-btn" id="nav-menu-btn" aria-label="Menu" aria-haspopup="true" aria-expanded="false" title="Navigate">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="nav-dropdown" id="nav-dropdown" role="menu">
          <a href="/" role="menuitem">Feed</a>
          <a href="/babel.html" role="menuitem">Babel Library</a>
          <a href="/sound.html" role="menuitem">Wall of Sound</a>
          <a href="/soundboard.html" role="menuitem">Soundboard</a>
          <a href="/dj.html" role="menuitem">DJ Table</a>
          <a href="/movie-maker.html" role="menuitem">Movie Maker</a>
          <a href="/draw/" role="menuitem">Draw</a>
          <a href="/users.html" role="menuitem">Find Friends</a>
          <a href="/suggestions.html" role="menuitem">Suggestions</a>
          <a href="/plans.html" role="menuitem">Plans</a>
          <a href="/hashes.html" role="menuitem">Image Hashes</a>
          <a href="/sound-hashes.html" role="menuitem" aria-current="page">Sound Hashes</a>
          <a href="/themes.html" role="menuitem">Themes</a>
          <a href="/#upload" role="menuitem">Upload Image</a>
          <a href="/#upload-audio" role="menuitem">Upload Audio</a>
          <a href="/#hash" role="menuitem">View by Hash</a>
          <a href="/#auth" role="menuitem">Sign in / Account</a>
          <a href="/contact.html" role="menuitem">Contact</a>
          <a href="/terms.html" role="menuitem">Terms of Use</a>
          <a href="/privacy.html" role="menuitem">Privacy Policy</a>
          <a href="/backend.html" class="nav-admin-only" role="menuitem">Backend</a>
        </div>
      </div>
    </nav>
  </header>

  <main class="sound-hashes-page">
    <a href="/" class="back-link">← Back to feed</a>
    <h1>Sound Hash Database</h1>
    <p class="subtitle">All sound hashes stored in SQLite · 30s mono at 8kHz</p>

    <div id="sound-hash-list">
      <p class="loading">Loading…</p>
    </div>
  </main>

  <script src="/nav-dropdown.js"></script>
  <script src="/shoot.js"></script>
  <script>
    function escapeHtml(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function loadSoundHashes() {
      const el = document.getElementById('sound-hash-list');
      try {
        const res = await fetch('/api/sound-hashes');
        const data = res.ok ? await res.json() : { items: [], count: 0 };
        if (!data.items?.length) {
          el.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon" aria-hidden="true">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                  <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
              </div>
              <p>No sounds in database yet. Upload a sound on the <a href="/sound.html">Wall of Sound</a> to get started.</p>
            </div>`;
          return;
        }
        el.innerHTML = `
          <p class="subtitle" style="margin-bottom:16px">${data.count} sound${data.count !== 1 ? 's' : ''} · Lookup by # or hash</p>
          <div class="sh-table-wrap">
          <table class="sh-table">
            <thead><tr><th>Play</th><th>#</th><th>Hash</th><th>Caption</th><th>Duration</th><th>Created</th><th>User</th><th>View</th></tr></thead>
            <tbody>
              ${data.items.map((item) => {
                const timeStr = item.createdAt ? new Date(item.createdAt).toLocaleString() : '—';
                const durStr = (item.duration != null && item.duration > 0) ? item.duration + 's' : '—';
                const capStr = (item.caption || '').trim() || '—';
                return `<tr>
                  <td><button type="button" class="sh-play-btn" data-hash="${escapeHtml(item.hash)}" title="Play">▶</button></td>
                  <td>${item.num}</td>
                  <td class="hash-cell">${escapeHtml(item.hash)}</td>
                  <td>${escapeHtml(capStr)}</td>
                  <td>${durStr}</td>
                  <td>${timeStr}</td>
                  <td>${(item.username && item.username !== '—') ? `<a href="/u/${encodeURIComponent(item.username)}">@${escapeHtml(item.username)}</a>` : `@${escapeHtml(item.username || '—')}`}</td>
                  <td><a href="/s/n/${item.num}">By #</a> · <a href="/sound.html#${encodeURIComponent(item.hash)}">Wall</a></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
          </div>
        `;
        el.querySelectorAll('.sh-play-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const hash = btn.dataset.hash;
            if (hash) {
              const a = new Audio(`/s/${hash}`);
              a.play().catch(() => {});
            }
          });
        });
      } catch (err) {
        el.innerHTML = '<p class="error">Failed to load sound hashes.</p>';
      }
    }
    loadSoundHashes();
  </script>
</body>
</html>
