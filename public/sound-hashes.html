<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tchoff — Sound Hash Database</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    .sound-hashes-page { max-width: 1000px; margin: 0 auto; padding: 32px 24px; }
    .sound-hashes-page h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .sound-hashes-page .subtitle { color: var(--text-muted); margin-bottom: 24px; }
    .sh-table { width: 100%; border-collapse: collapse; }
    .sh-table th { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; }
    .sh-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-family: var(--font-mono); font-size: 0.8rem; vertical-align: middle; }
    .sh-table tr:hover { background: var(--bg-card); }
    .sh-table .hash-cell { word-break: break-all; }
    .sh-table a { color: var(--accent); text-decoration: none; }
    .sh-table a:hover { text-decoration: underline; }
    .sh-table-wrap { overflow-x: auto; margin-top: 16px; border-radius: var(--radius); border: 1px solid var(--border); }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); margin-bottom: 24px; text-decoration: none; transition: color 0.2s; }
    .back-link:hover { color: var(--text); }
    .sh-play-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--bg);
      cursor: pointer;
    }
    .sh-play-btn:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Tchoff</a>
    <nav class="nav">
      <a href="/sound.html" class="btn-icon" title="Wall of Sound">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
          <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
        </svg>
      </a>
      <a href="/soundboard.html" class="btn-icon" title="Soundboard">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="6" width="4" height="12" rx="1"/>
          <rect x="8" y="4" width="4" height="16" rx="1"/>
          <rect x="14" y="8" width="4" height="8" rx="1"/>
          <rect x="20" y="2" width="2" height="20" rx="1"/>
        </svg>
      </a>
      <a href="/dj.html" class="btn-icon" title="DJ Table">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="8" height="16" rx="1"/>
          <rect x="14" y="4" width="8" height="16" rx="1"/>
          <path d="M10 8h4M10 12h4M10 16h4"/>
        </svg>
      </a>
      <a href="/babel.html" class="btn-icon" title="Babel Library">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="9"/>
          <path d="M12 3v6m0 6v6M3 12h6m6 0h6"/>
          <path d="M5.6 5.6l4.2 4.2m4.4 4.4l4.2 4.2M5.6 18.4l4.2-4.2m4.4-4.4l4.2-4.2"/>
        </svg>
      </a>
      <a href="/hashes.html" class="btn-icon" title="Image hash database">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
      </a>
      <a href="/sound-hashes.html" class="btn-icon" title="Sound hash database" style="background:var(--bg-card);border-color:var(--accent)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
          <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>
      </a>
      <a href="/" class="btn-icon" title="Feed" style="text-decoration:none">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
        </svg>
      </a>
    </nav>
  </header>

  <main class="sound-hashes-page">
    <a href="/" class="back-link">← Back to feed</a>
    <h1>Sound Hash Database</h1>
    <p class="subtitle">All sound hashes stored in SQLite · 30s mono at 8kHz</p>

    <div id="sound-hash-list">
      <p class="loading">Loading…</p>
    </div>
  </main>

  <script>
    function escapeHtml(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function loadSoundHashes() {
      const el = document.getElementById('sound-hash-list');
      try {
        const res = await fetch('/api/sound-hashes');
        const data = res.ok ? await res.json() : { items: [], count: 0 };
        if (!data.items?.length) {
          el.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon" aria-hidden="true">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                  <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
              </div>
              <p>No sounds in database yet. Upload a sound on the <a href="/sound.html">Wall of Sound</a> to get started.</p>
            </div>`;
          return;
        }
        el.innerHTML = `
          <p class="subtitle" style="margin-bottom:16px">${data.count} sound${data.count !== 1 ? 's' : ''} · Lookup by # or hash</p>
          <div class="sh-table-wrap">
          <table class="sh-table">
            <thead><tr><th>Play</th><th>#</th><th>Hash</th><th>Caption</th><th>Duration</th><th>Created</th><th>User</th><th>View</th></tr></thead>
            <tbody>
              ${data.items.map((item) => {
                const timeStr = item.createdAt ? new Date(item.createdAt).toLocaleString() : '—';
                const durStr = (item.duration != null && item.duration > 0) ? item.duration + 's' : '—';
                const capStr = (item.caption || '').trim() || '—';
                return `<tr>
                  <td><button type="button" class="sh-play-btn" data-hash="${escapeHtml(item.hash)}" title="Play">▶</button></td>
                  <td>${item.num}</td>
                  <td class="hash-cell">${escapeHtml(item.hash)}</td>
                  <td>${escapeHtml(capStr)}</td>
                  <td>${durStr}</td>
                  <td>${timeStr}</td>
                  <td>@${escapeHtml(item.username)}</td>
                  <td><a href="/s/n/${item.num}">By #</a> · <a href="/sound.html#${encodeURIComponent(item.hash)}">Wall</a></td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
          </div>
        `;
        el.querySelectorAll('.sh-play-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const hash = btn.dataset.hash;
            if (hash) {
              const a = new Audio(`/s/${hash}`);
              a.play().catch(() => {});
            }
          });
        });
      } catch (err) {
        el.innerHTML = '<p class="error">Failed to load sound hashes.</p>';
      }
    }
    loadSoundHashes();
  </script>
</body>
</html>
